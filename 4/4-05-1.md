# 資料收集

## 資料收集

OMFLOW 分為 Server 及 Collector，其中 Collector 可執行 Server 派送的流程以進行資料收集，以協助 OMFLOW 進行數據監控及分析。

### 收集器管理

#### 分類

```
位置：［主選單］＞資料收集＞收集器管理
```

1. **未分類**：所有初次報到的 Collector 會預設分類於此。
2. **分散運算**：當流程運行至勾選「分散運算」的程式碼元件時，會選擇此分類其中一個 Collector 運行程式碼元件，詳細可參考【應用管理＞程式碼元件】章節。

> ※ 每當 Collector 安裝或重啟後會在 5 分鐘內向 Server 報到。

#### 收集器清單

```
位置：［主選單］＞資料收集＞收集器管理＞［任一分類］
```

此處顯示當前分類的 Collector 清單，其中各欄位介紹如下：

1. **燈號**：綠燈為正常連線，紅燈為失去聯繫
2. **名稱**：管理者可編輯的 Collector 顯示名稱
3. **主機名稱**：此 Collector 所在主機的 hostname
4. **IP位置**：此 Collector 所在主機的 ip
5. **作業系統**：此 Collector 所在主機的作業系統類別

> ※ 被刪除的 Collector 如果還在持續運行並向主機報到，會再次出現在列表中

#### 收集器資訊

```
位置：［主選單］＞資料收集＞收集器管理＞［任一分類］＞［任一收集器］
```

**基本資訊**

顯示該收集器相關資訊，其中「IP位置、PORT」欄位可根據客戶環境進行變更，以確保 Server 能正確連線至 Collector。

**參數**

此處可設定 Collector 系統參數，與【應用管理＞參數管理】章節相同，當收集器流程使用**系統參數**功能時會進行引用此處設定。

**流程**

此處可查看派送至 Collector 之所有流程相關收集數據，也可針對個別流程進行取消指派。

### 收集器流程

```
位置：［主選單］＞資料收集＞收集器流程
```

此處顯示所有收集器流程，可派送至 Collector 定期執行開單作業並將資料回傳 Server，以下介面的操作介紹：

1. **新增**：與【應用管理＞應用設計】類似，可建立任意流程並指派收集器執行，其中**事件開單**頁籤可參考下一節。
2. **刪除**：刪除勾選流程。
3. **複製**：複製勾選流程並建立為新流程。
4. **派送**：指定勾選的收集器執行此流程。
5. **執行**：設定流程執行變數、排程，及執行的 Collector。
6. **數據**：檢視該流程所收集到的資料，並以折線圖顯現。

> 注意要點：
>
> 1. 收集器流程需要先**派送**至 Collector 後才能**執行**排程。
> 2. Collector 在流程結束時將「結束元件」的輸出資料返回 Server ，其資料來源為該流程於「結束」元件的輸出變數，相關設定可參考【應用管理＞結束元件】章節。

#### 事件開單

當 Collector 返回資料時，可於此處設定過濾規則，並在符合規則時升級成事件。

> ※ 事件相關欄位可使用該流程於「結束」元件的輸出變數，相關設定可參考【應用管理＞結束元件】章節。

#### 額外套件

當 Collector 在有對外網路的環境下能自行安裝流程所需套件，無需使用者手動安裝。若沒有對外網路，有以下兩個建議：

1. 若環境中架設私有 PIP Server，可參考【架設PyPI伺服器】章節。
2. 也可根據該 Collector 所需執行的收集器流程自行手動安裝。

### 收集器API

```
位置：［主選單］＞資料收集＞收集器API
```

建立收集器專屬API，使外部可直接對收集器呼叫流程並將流程結束元件的輸出傳回資料中心，每次呼叫僅會執行一次。

> 注意要點：
>
> 1. 由於資安考量，Collector 預設僅接受自身及資料中心API呼叫。如需要從外部呼叫，須登入 Collector 所在伺服器並對Apache下的 httpd.conf 新增信任IP。
> 2. API response內容為該派送流程「結束」元件的輸出變數，相關設定可參考【應用管理＞結束元件】章節。

### 事件管理

```
位置：［主選單］＞資料收集＞事件管理
```

所有事件都會集中至此進行管理，並有三個頁籤功能如下：

#### 事件列表

顯示所有事件，其中**來源類別**事件分為以下四種：

1. **資料收集**：由收集器流程的**事件規則**觸發產生的事件，當事件條件不成立時自動關閉。
2. **服務水準**：由應用管理的**服務水準**規則觸發，詳細可參考【應用管理＞服務水準】章節，當條件不成立或表單已關單時時自動關閉。
3. **定期檢查**：當Collector與Server連線中斷時觸發，恢復連線時自動關閉。
4. **API**：由外部系統透過API呼叫時產生，同樣需透過API進行關閉，詳細可參考下方【事故API】章節。

#### 事故規則

```
位置：［主選單］＞資料收集＞事件管理＞事故規則
```

當事件產生時，系統會檢查**事故規則**是否符合並產生事故單。大部分欄位為事故單基本欄位，其中**事故觸發條件**需同時滿足以下兩種條件才算成立：

1. **時間符合**：當此規則在指定時間範圍內達到指定符合次數時產生事件，如 1 天內符合 3 次，若空白，則每符合任 1 次都會產生事故單。
2. **欄位條件**：當所有指定欄位判定結果為真時視為符合。

> 注意事項：
>
> 1. 事件會由上至下檢查**事故規則**，一旦升級為事故便會停止。
> 2. 當相同事件已升級為事故便不會再產生新的事故單。

#### 事故API

```
位置：［主選單］＞資料收集＞事件管理＞事故API
```

提供外部系統對OMFLOW開立事件的API，由於資安考量 Collector 預設僅接受自身及資料中心API呼叫。如需要從外部呼叫，須登入 Collector 所在伺服器並對Apache下的 httpd.conf 新增信任IP。
